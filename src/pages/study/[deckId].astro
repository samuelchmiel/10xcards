---
import Layout from "@/layouts/Layout.astro";
import { StudyMode } from "@/components/study/StudyMode";

export const prerender = false;

const { deckId } = Astro.params;
const user = Astro.locals.user;
const supabase = Astro.locals.supabase;
const accessToken = Astro.cookies.get("sb-access-token")?.value ?? "";
const dueOnly = Astro.url.searchParams.get("due") === "true";

if (!user) {
  return Astro.redirect("/login");
}

if (!deckId) {
  return Astro.redirect("/dashboard");
}

// Fetch deck to verify ownership and get name
const { data: deck } = await supabase.from("decks").select("id, name, description").eq("id", deckId).single();

if (!deck) {
  return Astro.redirect("/dashboard");
}

// Fetch flashcards for the deck (with SM-2 fields for spaced repetition)
let query = supabase
  .from("flashcards")
  .select("id, front, back, easiness_factor, interval_days, repetitions, next_review_date")
  .eq("deck_id", deckId);

// Filter for due cards if requested
if (dueOnly) {
  const today = new Date().toISOString().split("T")[0];
  query = query.or(`next_review_date.is.null,next_review_date.lte.${today}`);
}

const { data: flashcards } = await query.order("created_at", { ascending: true });

const studyTitle = dueOnly ? `Review Due - ${deck.name}` : `Study - ${deck.name}`;
---

<Layout title={`${studyTitle} - 10xCards`}>
  <StudyMode
    client:load
    deckName={deck.name}
    flashcards={flashcards || []}
    accessToken={accessToken}
    spacedRepetitionMode={true}
  />
</Layout>
